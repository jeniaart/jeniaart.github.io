<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baby-talk/Child-Directed Speech</title>
    <!-- Add Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div class="">
        <div class="max-w-full mx-auto bg-white rounded-lg shadow-md">
            <div class="px-3 pt-5 pb-3">
                <h1 class="text-gray-800 mb-0 text-xl font-medium">Baby-talk/Child-Directed Speech</h1>
                <h2 class="text-gray-600 font-normal">For all regions</h2>
            </div>
            <div class="mb-5">
                <input type="text" 
                    id="searchInput" 
                    placeholder="Search in any column..." 
                    class="w-full p-2.5 text-base border-t border-b border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <!-- Add a scrollable container for the table -->
            <div class="overflow-x-auto">
                <table id="dataTable" class="w-full border-collapse">
                    <thead>
                        <!-- Headers will be dynamically inserted here -->
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // Global variables
        let csvFilePath = 'cds_data_all.csv';
        let tableData = [];
        let currentSortColumn = null;
        let isAscending = true;
        let headers = [];

        // Function to load and parse CSV data using Papa Parse
        async function loadCSVData() {
            try {
                const response = await fetch(csvFilePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.data && results.data.length > 0) {
                            // Store the headers
                            headers = Object.keys(results.data[0]);
                            
                            // Create table headers dynamically
                            createTableHeaders(headers);
                            
                            // Map the data using the detected headers
                            tableData = results.data.map(row => 
                                headers.map(header => row[header] || '')
                            );
                            
                            displayData(tableData);
                        } else {
                            showError('No data found in CSV file');
                        }
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        showError('Error parsing the CSV file');
                    }
                });
            } catch (error) {
                console.error('Error loading CSV:', error);
                showError(`Error loading the CSV file: ${error.message}`);
            }
        }

        // Function to create table headers dynamically
        function createTableHeaders(headers) {
            const thead = document.querySelector('#dataTable thead');
            const tr = document.createElement('tr');
            
            headers.forEach(header => {
                const th = document.createElement('th');
                
                // Create container for header content
                const headerContainer = document.createElement('div');
                headerContainer.className = 'font-medium flex-1 whitespace-nowrap'; // Force single line
                headerContainer.innerHTML = header;
                
                // Create sort button with initial both-directions SVG
                const sortButton = document.createElement('button');
                sortButton.className = 'sort-icon absolute right-2 top-1/2 transform -translate-y-1/2 w-6 h-6 flex items-center justify-center';
                sortButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                        <path fill-rule="evenodd" d="M13.78 10.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 0 1-1.06 0l-2.25-2.25a.75.75 0 1 1 1.06-1.06l.97.97V5.75a.75.75 0 0 1 1.5 0v5.69l.97-.97a.75.75 0 0 1 1.06 0ZM2.22 5.53a.75.75 0 0 1 0-1.06l2.25-2.25a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v5.69a.75.75 0 0 1-1.5 0V4.56l-.97.97a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                    </svg>
                `;
                
                // Create wrapper div to hold both header content and sort button
                const wrapper = document.createElement('div');
                wrapper.className = 'flex relative pr-8'; // pr-8 for sort button space
                wrapper.appendChild(headerContainer);
                wrapper.appendChild(sortButton);
                
                th.appendChild(wrapper);
                th.className = 'p-3 text-left bg-gray-50 hover:bg-gray-100 relative min-w-[150px] w-[1%]';
                
                sortButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = Array.from(th.parentElement.children).indexOf(th);
                    sortData(index);
                });
                
                tr.appendChild(th);
            });
            
            thead.innerHTML = '';
            thead.appendChild(tr);
            
            const headerElements = document.querySelectorAll('th');
            headerElements.forEach((header, index) => {
                header.addEventListener('click', () => sortData(index));
            });
        }

        // Function to highlight search terms in text
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            // Return the original text - the highlighting will be handled by the container
            return text;
        }

        // Function to display data in the table
        function displayData(data, searchTerm = '') {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.className = 'p-3 border-b border-gray-200 min-w-[150px] cursor-pointer relative';
                    const cellText = cell || '';
                    
                    // Create a container for the content
                    const contentContainer = document.createElement('div');
                    contentContainer.className = 'truncate transition-all duration-200';
                    
                    // Add highlight class if the cell contains the search term
                    if (searchTerm && cellText.toLowerCase().includes(searchTerm.toLowerCase())) {
                        contentContainer.classList.add('cell-highlight');
                    }
                    
                    contentContainer.textContent = cellText;
                    
                    // Add click handler for expanding
                    td.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent document click from immediately closing
                        
                        // If not already expanded, expand it
                        if (!contentContainer.classList.contains('expanded')) {
                            // Reset all other cells first
                            document.querySelectorAll('.expanded').forEach(el => {
                                el.classList.remove('expanded', 'whitespace-pre-wrap');
                                el.classList.add('truncate');
                            });
                            
                            contentContainer.classList.remove('truncate');
                            contentContainer.classList.add('expanded', 'whitespace-pre-wrap');
                        }
                    });
                    
                    td.appendChild(contentContainer);
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        // Update the sortData function
        function sortData(columnIndex) {
            const headers = document.querySelectorAll('th');
            const sortButtons = document.querySelectorAll('.sort-icon');
            
            // Reset all sort icons to default (both directions)
            sortButtons.forEach(button => {
                button.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                        <path fill-rule="evenodd" d="M13.78 10.47a.75.75 0 0 1 0 1.06l-2.25 2.25a.75.75 0 0 1-1.06 0l-2.25-2.25a.75.75 0 1 1 1.06-1.06l.97.97V5.75a.75.75 0 0 1 1.5 0v5.69l.97-.97a.75.75 0 0 1 1.06 0ZM2.22 5.53a.75.75 0 0 1 0-1.06l2.25-2.25a.75.75 0 0 1 1.06 0l2.25 2.25a.75.75 0 0 1-1.06 1.06l-.97-.97v5.69a.75.75 0 0 1-1.5 0V4.56l-.97.97a.75.75 0 0 1-1.06 0Z" clip-rule="evenodd" />
                    </svg>
                `;
            });

            // Update sort direction
            if (currentSortColumn === columnIndex) {
                isAscending = !isAscending;
            } else {
                currentSortColumn = columnIndex;
                isAscending = true;
            }

            // Update sort icon for the current column
            const currentSortButton = sortButtons[columnIndex];
            currentSortButton.innerHTML = isAscending ? `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                    <path fill-rule="evenodd" d="M8 14a.75.75 0 0 1-.75-.75V4.56L4.03 7.78a.75.75 0 0 1-1.06-1.06l4.5-4.5a.75.75 0 0 1 1.06 0l4.5 4.5a.75.75 0 0 1-1.06 1.06L8.75 4.56v8.69A.75.75 0 0 1 8 14Z" clip-rule="evenodd" />
                </svg>
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="size-4">
                    <path fill-rule="evenodd" d="M8 2a.75.75 0 0 1 .75.75v8.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.22 3.22V2.75A.75.75 0 0 1 8 2Z" clip-rule="evenodd" />
                </svg>
            `;

            // Sort the data
            tableData.sort((a, b) => {
                const valueA = (a[columnIndex] || '').toLowerCase();
                const valueB = (b[columnIndex] || '').toLowerCase();
                return isAscending 
                    ? valueA.localeCompare(valueB)
                    : valueB.localeCompare(valueA);
            });

            displayData(tableData);
        }

        // Function to filter data
        function filterData(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const filteredData = tableData.filter(row =>
                row.some(cell => (cell || '').toLowerCase().includes(searchTerm))
            );
            displayData(filteredData, searchTerm);
        }

        // Function to show error message
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, document.querySelector('#searchInput').parentElement);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadCSVData();

            // Add search handler
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => filterData(e.target.value));
        });

        // Update the document click handler to handle both headers and cells
        document.addEventListener('click', (e) => {
            // If click is not inside an expanded element, collapse all expanded elements
            if (!e.target.closest('.expanded')) {
                document.querySelectorAll('.expanded').forEach(el => {
                    el.classList.remove('expanded', 'whitespace-pre-wrap');
                    el.classList.add('truncate');
                });
            }
        });

        // Update the style block
        const style = document.createElement('style');
        style.textContent = `
            .sort-icon::after {
                content: '';
            }
            .sort-icon {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .sort-icon svg {
                width: 16px;
                height: 16px;
                color: #999;
            }
            .cell-highlight {
                background-color: #fef3c7;
                border-radius: 4px;
                padding: 0.5rem;
                margin: -0.5rem;
            }
            .expanded {
                max-width: none !important;
                background-color: #f8fafc;
                box-shadow: 0 0 0 2px #3b82f6;
                border-radius: 4px;
                padding: 0.5rem;
                margin: -0.5rem;
                position: relative;
                z-index: 5;
                cursor: text;
            }
            /* Update table layout styles */
            #dataTable {
                table-layout: fixed;
                width: max-content;
                min-width: 100%;
            }
            /* Ensure header text doesn't wrap */
            th div {
                overflow: visible;
            }
            /* Force cells to respect column width */
            td {
                width: 0;
                max-width: 0;
            }
            /* Ensure expanded content doesn't get cut off by scroll container */
            .expanded {
                max-height: none;
                z-index: 20;
            }
            /* Add smooth scrolling to the container */
            .overflow-x-auto {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
